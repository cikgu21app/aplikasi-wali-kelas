import React, { useState, useEffect, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from 'firebase/auth';
import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from 'firebase/firestore';

// Pastikan variabel global ini tersedia di lingkungan Canvas
// Menggunakan firebaseConfig langsung jika __firebase_config tidak ada, dan projectId sebagai appId default
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
  apiKey: "AIzaSyBBITfGCCUZVyr8n7bBuH9vd3OZC29eU2I",
  authDomain: "wali-kelas-smkn-1-cilaku.firebaseapp.com",
  projectId: "wali-kelas-smkn-1-cilaku",
  storageBucket: "wali-kelas-smkn-1-cilaku.firebasestorage.app",
  messagingSenderId: "213267372176",
  appId: "1:213267372176:web:8ba770b210aec459c32015",
  measurementId: "G-SW60GEC300"
};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId; // Menggunakan projectId sebagai appId default jika __app_id tidak ada

// Konteks untuk Firebase dan User
const FirebaseContext = createContext(null);

function App() {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [user, setUser] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [currentPage, setCurrentPage] = useState('dashboard'); // State untuk navigasi halaman

  useEffect(() => {
    let unsubscribeAuth = () => {}; // Inisialisasi unsubscribe agar selalu ada

    const initializeFirebaseAndAuth = async () => {
      try {
        const app = initializeApp(firebaseConfig);
        const firestoreDb = getFirestore(app);
        const firebaseAuth = getAuth(app);
        setDb(firestoreDb);
        setAuth(firebaseAuth);

        // Listener untuk perubahan status autentikasi
        unsubscribeAuth = onAuthStateChanged(firebaseAuth, async (currentUser) => {
          if (currentUser) {
            let userData = { ...currentUser };
            setUserId(currentUser.uid);

            // Jika pengguna adalah anonim atau belum memiliki data profil lengkap,
            // coba ambil data profil dari Firestore
            // Perhatikan: Jika menggunakan Custom Token, data ini harusnya sudah disediakan oleh backend.
            // Ini adalah bagian dari "simulasi" login Anda yang asli.
            const userDocRef = doc(firestoreDb, `artifacts/${appId}/users/${currentUser.uid}/profile/data`);
            try {
              const userDocSnap = await getDoc(userDocRef);
              if (userDocSnap.exists()) {
                userData = { ...currentUser, ...userDocSnap.data() };
              } else {
                // Untuk pengguna anonim yang baru, buat dokumen profil dasar jika belum ada
                if (currentUser.isAnonymous) {
                  await setDoc(userDocRef, {
                    nik: currentUser.uid, // Menggunakan UID sebagai NIK sementara
                    nama: "Pengguna Anonim",
                    role: "anonim",
                    kelasDiampu: []
                  }, { merge: true });
                  userData = { ...currentUser, nik: currentUser.uid, nama: "Pengguna Anonim", role: "anonim", kelasDiampu: [] };
                  console.log("Created basic profile for new anonymous user.");
                }
              }
            } catch (profileError) {
              console.error("Error fetching or creating user profile:", profileError);
            }
            setUser(userData);
          } else {
            setUser(null);
            setUserId(null);
          }
          setIsAuthReady(true);
        });

        // Sign in dengan custom token jika tersedia, atau secara anonim
        const signInUser = async () => {
          try {
            if (initialAuthToken) {
              await signInWithCustomToken(firebaseAuth, initialAuthToken);
              console.log("Signed in with custom token.");
            } else {
              await signInAnonymously(firebaseAuth);
              console.log("Signed in anonymously.");
            }
          } catch (error) {
            console.error("Error during Firebase sign-in:", error);
            // Fallback to anonymous if custom token fails or any other sign-in error occurs
            if (firebaseAuth.currentUser === null || firebaseAuth.currentUser.isAnonymous === false) {
              console.log("Attempting to sign in anonymously as fallback...");
              try {
                await signInAnonymously(firebaseAuth);
                console.log("Signed in anonymously after initial sign-in attempt failure.");
              } catch (anonError) {
                console.error("Error signing in anonymously as fallback:", anonError);
                // Jika login anonim juga gagal, mungkin ada masalah koneksi atau konfigurasi Firebase
              }
            }
          }
        };

        signInUser();

      } catch (error) {
        console.error("Failed to initialize Firebase:", error);
        setIsAuthReady(true); // Pastikan auth siap bahkan jika inisialisasi gagal
      }
    };

    initializeFirebaseAndAuth();

    return () => {
      unsubscribeAuth();
    };
  }, []); // Dependensi kosong karena inisialisasi hanya perlu dijalankan sekali

  // Panggil inisialisasi demo data setelah db terinisialisasi
  useEffect(() => {
    if (db) {
      initializeDemoData(db, appId);
    }
  }, [db, appId]); // Menambahkan appId sebagai dependensi

  const handleLogout = async () => {
    if (auth) {
      try {
        await signOut(auth);
        setCurrentPage('login'); // Kembali ke halaman login setelah logout
        console.log("User logged out successfully.");
      } catch (error) {
        console.error("Error logging out:", error);
      }
    }
  };

  if (!isAuthReady) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div className="text-center text-gray-700">Memuat aplikasi...</div>
      </div>
    );
  }

  return (
    <FirebaseContext.Provider value={{ db, auth, user, userId, appId }}>
      <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
        {!user || currentPage === 'login' ? (
          <LoginPage onLoginSuccess={() => setCurrentPage('dashboard')} />
        ) : (
          <MainLayout currentPage={currentPage} setCurrentPage={setCurrentPage} handleLogout={handleLogout} />
        )}
      </div>
    </FirebaseContext.Provider>
  );
}

// --- Komponen Halaman Login ---
function LoginPage({ onLoginSuccess }) {
  const { db, auth, appId, userId } = useContext(FirebaseContext);
  const [nik, setNik] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [showInfoModal, setShowInfoModal] = useState(false);

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    if (!db || !auth) {
      setError("Firebase belum terinisialisasi.");
      setLoading(false);
      return;
    }

    try {
      // Simulasikan login NIK/NIK dengan mencari user di Firestore
      // PENTING: Untuk aplikasi produksi, bagian ini HARUS dilakukan di server backend yang aman
      // untuk memvalidasi kredensial dan mencetak Custom Token Firebase.
      const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
      // Warning: Query ini mungkin memerlukan indeks Firestore
      const q = query(usersRef, where("nik", "==", nik), where("password", "==", password)); // Password juga NIK
      const querySnapshot = await getDocs(q);

      if (!querySnapshot.empty) {
        const userData = querySnapshot.docs[0].data();
        // Karena Firebase Auth tidak mendukung NIK langsung, kita akan "menandai" user ini sebagai logged in
        // dengan mengupdate profil user anonim yang sudah ada atau membuat yang baru.
        // Ini adalah workaround untuk demo. Dalam produksi, setelah validasi NIK/password di backend,
        // backend akan mencetak Custom Token dan klien akan signInWithCustomToken.
        const currentUser = auth.currentUser;
        if (currentUser) {
          const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/profile/data`);
          await setDoc(userProfileRef, {
            nik: userData.nik,
            nama: userData.nama,
            role: userData.role,
            kelasDiampu: userData.kelasDiampu || [],
          }, { merge: true }); // Merge agar tidak menimpa data lain jika ada
          console.log("User profile updated for anonymous user:", userData.nik);
        } else {
          // Ini seharusnya tidak terjadi jika inisialisasi di App.js sudah mengautentikasi anonim.
          // Namun, sebagai fallback.
          console.warn("No current Firebase user during login simulation. Anonymous sign-in may have failed.");
          // Coba sign in anonim lagi jika tidak ada currentUser
          await signInAnonymously(auth);
          const newCurrentUser = auth.currentUser;
          if (newCurrentUser) {
            const userProfileRef = doc(db, `artifacts/${appId}/users/${newCurrentUser.uid}/profile/data`);
            await setDoc(userProfileRef, {
              nik: userData.nik,
              nama: userData.nama,
              role: userData.role,
              kelasDiampu: userData.kelasDiampu || [],
            }, { merge: true });
            console.log("User profile created for newly signed-in anonymous user:", userData.nik);
          }
        }
        onLoginSuccess(); // Panggil callback untuk mengubah halaman
      } else {
        setError('NIK atau Password salah. Silakan coba lagi.');
      }
    } catch (err) {
      console.error("Error during login (Firestore query/profile update):", err);
      setError('Terjadi kesalahan saat login. Pastikan Anda memiliki izin akses ke Firestore.');
    } finally {
      setLoading(false);
    }
  };

  const handleInfoClick = () => {
    setShowInfoModal(true);
  };

  const handleCloseInfoModal = () => {
    setShowInfoModal(false);
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-indigo-600 p-4">
      <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 hover:scale-105">
        <h2 className="text-3xl font-extrabold text-center text-gray-900 mb-6">
          Aplikasi Wali Kelas
        </h2>
        <p className="text-center text-gray-600 mb-8">
          SMKN 1 Cilaku
        </p>

        <form onSubmit={handleLogin} className="space-y-6">
          <div>
            <label htmlFor="nik" className="block text-sm font-medium text-gray-700">
              NIK (Username)
            </label>
            <input
              type="text"
              id="nik"
              name="nik"
              value={nik}
              onChange={(e) => setNik(e.target.value)}
              required
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
              placeholder="Masukkan NIK Anda"
            />
          </div>
          <div>
            <label htmlFor="password" className="block text-sm font-medium text-gray-700">
              Password (NIK)
            </label>
            <input
              type="password"
              id="password"
              name="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
              placeholder="Masukkan NIK Anda sebagai password"
            />
          </div>

          {error && (
            <p className="text-red-600 text-sm text-center">{error}</p>
          )}

          <button
            type="submit"
            className={`w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}
            disabled={loading}
          >
            {loading ? 'Memproses...' : 'Login'}
          </button>
        </form>

        <div className="mt-6 text-center">
          <button
            onClick={handleInfoClick}
            className="text-sm text-indigo-600 hover:text-indigo-800 transition duration-150 ease-in-out"
          >
            Info Login
          </button>
        </div>

        {showInfoModal && (
          <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-xl p-6 max-w-sm w-full">
              <h3 className="text-xl font-bold mb-4 text-gray-900">Informasi Login (Contoh)</h3>
              <p className="text-gray-700 mb-4">
                Untuk tujuan demo, Anda bisa login dengan NIK berikut:
              </p>
              <ul className="list-disc list-inside text-gray-700 mb-4">
                <li><strong>Wali Kelas (X, XI B, XII C):</strong> NIK: 196801022005012006, Password: 196801022005012006</li>
                <li><strong>Wali Kelas (XI A):</strong> NIK: 197503152000021001, Password: 197503152000021001</li>
                <li><strong>Wali Kelas (XII A):</strong> NIK: 198007202008032002, Password: 198007202008032002</li>
                <li><strong>Admin Kurikulum:</strong> NIK: admin, Password: admin</li>
              </ul>
              <p className="text-gray-700 mb-4">
                Data pengguna ini sudah ada di Firestore.
              </p>
              <button
                onClick={handleCloseInfoModal}
                className="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
              >
                Tutup
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}


// --- Komponen Layout Utama Aplikasi ---
function MainLayout({ currentPage, setCurrentPage, handleLogout }) {
  const { db, user, userId, appId } = useContext(FirebaseContext);
  const [waliKelasName, setWaliKelasName] = useState('Wali Kelas');
  const [waliKelasClasses, setWaliKelasClasses] = useState([]);
  const [allClasses, setAllClasses] = useState([]); // State untuk semua kelas (untuk admin)

  useEffect(() => {
    if (!db || !user || !user.uid) {
      // Tunggu hingga db dan user tersedia
      return;
    }

    setWaliKelasName(user.nama || 'Wali Kelas');
    const userRole = user.role || 'anonim'; // Pastikan role ada, default ke 'anonim'

    if (userRole === 'walikelas') {
      setWaliKelasClasses(user.kelasDiampu || []);
    } else if (userRole === 'admin') {
      // Fetch all classes for admin
      const classesRef = collection(db, `artifacts/${appId}/public/data/classes`);
      const unsubscribe = onSnapshot(classesRef, (snapshot) => {
        const classesData = snapshot.docs.map(doc => doc.data().namaKelas).sort();
        setAllClasses(classesData);
      }, (err) => {
        console.error("Error fetching all classes for admin:", err);
        // Tangani error, mungkin dengan menampilkan pesan ke pengguna
      });
      return () => unsubscribe();
    } else {
      // Untuk peran lain atau anonim, mungkin tidak ada kelas diampu
      setWaliKelasClasses([]);
      setAllClasses([]);
    }
  }, [user, db, appId]); // Menambahkan db dan appId sebagai dependensi

  // Tampilkan userId di UI
  const displayUserId = userId || 'N/A';
  const userRole = user?.role || 'anonim';

  return (
    <div className="flex flex-col min-h-screen">
      {/* Header */}
      <header className="bg-indigo-700 text-white p-4 shadow-md flex justify-between items-center print:hidden">
        <div className="flex items-center">
          <h1 className="text-2xl font-bold">Aplikasi Wali Kelas SMKN 1 Cilaku</h1>
          <span className="ml-4 text-sm bg-indigo-800 px-3 py-1 rounded-full">
            {waliKelasName} ({userRole === 'admin' ? 'Admin Kurikulum' : userRole}) ({displayUserId})
          </span>
        </div>
        <nav>
          <ul className="flex space-x-4">
            <li><button onClick={() => setCurrentPage('dashboard')} className={`px-3 py-2 rounded-md ${currentPage === 'dashboard' ? 'bg-indigo-800' : 'hover:bg-indigo-600'}`}>Dashboard</button></li>
            <li><button onClick={() => setCurrentPage('studentManagement')} className={`px-3 py-2 rounded-md ${currentPage === 'studentManagement' ? 'bg-indigo-800' : 'hover:bg-indigo-600'}`}>Data Siswa</button></li>
            <li><button onClick={() => setCurrentPage('attendance')} className={`px-3 py-2 rounded-md ${currentPage === 'attendance' ? 'bg-indigo-800' : 'hover:bg-indigo-600'}`}>Kehadiran</button></li>
            <li><button onClick={() => setCurrentPage('caseBook')} className={`px-3 py-2 rounded-md ${currentPage === 'caseBook' ? 'bg-indigo-800' : 'hover:bg-indigo-600'}`}>Buku Kasus</button></li>
            <li><button onClick={() => setCurrentPage('mutation')} className={`px-3 py-2 rounded-md ${currentPage === 'mutation' ? 'bg-indigo-800' : 'hover:bg-indigo-600'}`}>Mutasi Siswa</button></li>
            <li>
              <button
                onClick={() => setCurrentPage('reports')}
                className={`px-3 py-2 rounded-md ${currentPage === 'reports' ? 'bg-indigo-800' : 'hover:bg-indigo-600'}`}
              >
                Laporan
              </button>
            </li>
            {userRole === 'admin' && (
              <li>
                <button
                  onClick={() => setCurrentPage('userManagement')}
                  className={`px-3 py-2 rounded-md ${currentPage === 'userManagement' ? 'bg-indigo-800' : 'hover:bg-indigo-600'}`}
                >
                  Manajemen Pengguna
                </button>
              </li>
            )}
            <li><button onClick={handleLogout} className="px-3 py-2 rounded-md bg-red-600 hover:bg-red-700">Logout</button></li>
          </ul>
        </nav>
      </header>

      {/* Main Content */}
      <main className="flex-grow p-6 bg-gray-50">
        {currentPage === 'dashboard' && <Dashboard waliKelasClasses={userRole === 'admin' ? allClasses : waliKelasClasses} />}
        {currentPage === 'studentManagement' && <StudentManagement waliKelasClasses={userRole === 'admin' ? allClasses : waliKelasClasses} />}
        {currentPage === 'attendance' && <Attendance waliKelasClasses={userRole === 'admin' ? allClasses : waliKelasClasses} />}
        {currentPage === 'caseBook' && <CaseBook waliKelasClasses={userRole === 'admin' ? allClasses : waliKelasClasses} />}
        {currentPage === 'mutation' && <Mutation waliKelasClasses={userRole === 'admin' ? allClasses : waliKelasClasses} />}
        {currentPage === 'reports' && <Reports waliKelasClasses={userRole === 'admin' ? allClasses : waliKelasClasses} userRole={userRole} />}
        {currentPage === 'userManagement' && userRole === 'admin' && <UserManagement allClasses={allClasses} />}
      </main>

      {/* Footer */}
      <footer className="bg-gray-800 text-white p-4 text-center text-sm print:hidden">
        <p>SMKN 1 Cilaku - Jl. Raya Cibeber KM. 7 Kubangsari</p>
        <p>Kepala Sekolah: Dra. Rusmini, M.M.Pd - NIP: 19680102 200501 2 006</p>
        <p className="mt-2">UserID Aktif: {displayUserId}</p>
      </footer>
    </div>
  );
}

// --- Komponen Dashboard ---
function Dashboard({ waliKelasClasses }) {
  const { db, appId } = useContext(FirebaseContext);
  const [selectedClass, setSelectedClass] = useState('');
  const [totalStudents, setTotalStudents] = useState(0);
  const [recentCases, setRecentCases] = useState([]);
  const [todayAttendanceSummary, setTodayAttendanceSummary] = useState({ hadir: 0, sakit: 0, izin: 0, alpha: 0 });

  useEffect(() => {
    if (waliKelasClasses.length > 0) {
      setSelectedClass(waliKelasClasses[0]); // Default to first class
    } else {
      setSelectedClass(''); // Clear selected class if no classes are available
    }
  }, [waliKelasClasses]);

  useEffect(() => {
    if (!db || !selectedClass) return;

    // Fetch total students
    const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
    const qStudents = query(studentsRef, where("kelas", "==", selectedClass));
    const unsubscribeStudents = onSnapshot(qStudents, (snapshot) => {
      setTotalStudents(snapshot.size);
    }, (err) => {
      console.error("Error fetching students for dashboard:", err);
    });

    // Fetch recent cases (last 5)
    const casesRef = collection(db, `artifacts/${appId}/public/data/cases`);
    // Note: Firestore's orderBy and limit require an index. For demo, we fetch all
    // and sort/limit client-side if no index is configured.
    const qCases = query(casesRef, where("kelas", "==", selectedClass));
    const unsubscribeCases = onSnapshot(qCases, (snapshot) => {
      const casesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
        .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)) // Sort by date descending
        .slice(0, 5); // Take top 5
      setRecentCases(casesData);
    }, (err) => {
      console.error("Error fetching recent cases for dashboard:", err);
    });

    // Fetch today's attendance summary
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    const attendanceRef = collection(db, `artifacts/${appId}/public/data/attendance`);
    const qAttendance = query(attendanceRef, where("kelas", "==", selectedClass), where("tanggal", "==", today));
    const unsubscribeAttendance = onSnapshot(qAttendance, (snapshot) => {
      let hadir = 0;
      let sakit = 0;
      let izin = 0;
      let alpha = 0;
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.status === 'Hadir') hadir++;
        if (data.status === 'Sakit') sakit++;
        if (data.status === 'Izin') izin++;
        if (data.status === 'Alpha') alpha++;
      });
      setTodayAttendanceSummary({ hadir, sakit, izin, alpha });
    }, (err) => {
      console.error("Error fetching today's attendance for dashboard:", err);
    });

    return () => {
      unsubscribeStudents();
      unsubscribeCases();
      unsubscribeAttendance();
    };
  }, [db, selectedClass, appId]);

  return (
    <div className="p-6 bg-white rounded-xl shadow-lg">
      <h2 className="text-3xl font-bold text-gray-900 mb-6">Dashboard Wali Kelas</h2>

      <div className="mb-6">
        <label htmlFor="select-class" className="block text-lg font-medium text-gray-700 mb-2">Pilih Kelas:</label>
        <select
          id="select-class"
          value={selectedClass}
          onChange={(e) => setSelectedClass(e.target.value)}
          className="mt-1 block w-full md:w-1/2 lg:w-1/3 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"
        >
          {waliKelasClasses.length > 0 ? (
            waliKelasClasses.map(cls => (
              <option key={cls} value={cls}>{cls}</option>
            ))
          ) : (
            <option value="">Tidak ada kelas diampu</option>
          )}
        </select>
      </div>

      {selectedClass && (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
          <div className="bg-blue-100 p-6 rounded-xl shadow-md flex flex-col items-center justify-center">
            <h3 className="text-xl font-semibold text-blue-800 mb-2">Jumlah Siswa ({selectedClass})</h3>
            <p className="text-5xl font-extrabold text-blue-900">{totalStudents}</p>
          </div>
          <div className="bg-green-100 p-6 rounded-xl shadow-md flex flex-col items-center justify-center">
            <h3 className="text-xl font-semibold text-green-800 mb-2">Kehadiran Hari Ini ({selectedClass})</h3>
            <div className="text-center">
              <p className="text-2xl font-bold text-green-900">Hadir: {todayAttendanceSummary.hadir}</p>
              <p className="text-xl text-yellow-800">Sakit: {todayAttendanceSummary.sakit}</p>
              <p className="text-xl text-orange-800">Izin: {todayAttendanceSummary.izin}</p>
              <p className="text-xl text-red-800">Alpha: {todayAttendanceSummary.alpha}</p>
            </div>
          </div>
          <div className="bg-purple-100 p-6 rounded-xl shadow-md">
            <h3 className="text-xl font-semibold text-purple-800 mb-4">Kasus Terbaru ({selectedClass})</h3>
            {recentCases.length > 0 ? (
              <ul className="space-y-2">
                {recentCases.map(kasus => (
                  <li key={kasus.id} className="bg-purple-50 p-3 rounded-lg border border-purple-200">
                    <p className="text-sm font-medium text-purple-900">{kasus.tanggal} - {kasus.namaSiswa}</p>
                    <p className="text-xs text-purple-700 truncate">{kasus.jenisKasus}: {kasus.deskripsi}</p>
                  </li>
                ))}
              </ul>
            ) : (
              <p className="text-gray-600">Tidak ada kasus terbaru.</p>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

// --- Komponen StudentManagement ---
function StudentManagement({ waliKelasClasses }) {
  const { db, appId } = useContext(FirebaseContext);
  const [students, setStudents] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [selectedClass, setSelectedClass] = useState('');
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [currentStudent, setCurrentStudent] = useState({
    id: null, nis: '', nama: '', kelas: '', tanggalLahir: '', alamat: '', nomorTeleponOrtu: '', statusSiswa: 'Aktif'
  });
  const [searchTerm, setSearchTerm] = useState('');
  const [showDeleteConfirmModal, setShowDeleteConfirmModal] = useState(false); // State untuk modal konfirmasi hapus
  const [studentToDelete, setStudentToDelete] = useState(null); // State untuk menyimpan siswa yang akan dihapus

  useEffect(() => {
    if (waliKelasClasses.length > 0) {
      setSelectedClass(waliKelasClasses[0]);
    } else {
      setSelectedClass(''); // Clear selected class if no classes are available
    }
  }, [waliKelasClasses]);

  useEffect(() => {
    if (!db || !selectedClass) {
      setStudents([]); // Kosongkan siswa jika kelas tidak dipilih/db tidak siap
      setLoading(false);
      return;
    }

    setLoading(true);
    setError('');
    const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
    const q = query(studentsRef, where("kelas", "==", selectedClass));

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const studentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setStudents(studentsData);
      setLoading(false);
    }, (err) => {
      console.error("Error fetching students:", err);
      setError("Gagal memuat data siswa. Pastikan Anda memiliki izin akses Firestore.");
      setLoading(false);
    });

    return () => unsubscribe();
  }, [db, selectedClass, appId]);

  const filteredStudents = students.filter(student =>
    student.nama.toLowerCase().includes(searchTerm.toLowerCase()) ||
    student.nis.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const handleAddStudent = () => {
    setIsEditing(false);
    setCurrentStudent({
      id: null, nis: '', nama: '', kelas: selectedClass, tanggalLahir: '', alamat: '', nomorTeleponOrtu: '', statusSiswa: 'Aktif'
    });
    setShowModal(true);
  };

  const handleEditStudent = (student) => {
    setIsEditing(true);
    setCurrentStudent({ ...student });
    setShowModal(true);
  };

  const confirmDeleteStudent = (student) => {
    setStudentToDelete(student);
    setShowDeleteConfirmModal(true);
  };

  const handleDeleteStudent = async () => {
    if (!studentToDelete || !db) return;

    try {
      await deleteDoc(doc(db, `artifacts/${appId}/public/data/students`, studentToDelete.id));
      console.log("Siswa berhasil dihapus!");
      setShowDeleteConfirmModal(false);
      setStudentToDelete(null);
    } catch (err) {
      console.error("Error deleting student:", err);
      setError("Gagal menghapus siswa. Pastikan Anda memiliki izin akses Firestore.");
    }
  };

  const handleSaveStudent = async (e) => {
    e.preventDefault();
    setError('');
    try {
      if (isEditing) {
        // Hapus ID dari object sebelum update karena ID tidak perlu disimpan di dalam dokumen
        const { id, ...dataToUpdate } = currentStudent;
        await updateDoc(doc(db, `artifacts/${appId}/public/data/students`, id), dataToUpdate);
        console.log("Siswa berhasil diperbarui!");
      } else {
        await addDoc(collection(db, `artifacts/${appId}/public/data/students`), { ...currentStudent, kelas: selectedClass });
        console.log("Siswa berhasil ditambahkan!");
      }
      setShowModal(false);
    } catch (err) {
      console.error("Error saving student:", err);
      setError("Gagal menyimpan data siswa. Pastikan Anda memiliki izin akses Firestore.");
    }
  };

  return (
    <div className="p-6 bg-white rounded-xl shadow-lg">
      <h2 className="text-3xl font-bold text-gray-900 mb-6">Manajemen Data Siswa</h2>

      <div className="mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4">
        <div className="w-full md:w-1/3">
          <label htmlFor="class-filter" className="sr-only">Pilih Kelas</label>
          <select
            id="class-filter"
            value={selectedClass}
            onChange={(e) => setSelectedClass(e.target.value)}
            className="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"
          >
            {waliKelasClasses.length > 0 ? (
              waliKelasClasses.map(cls => (
                <option key={cls} value={cls}>{cls}</option>
              ))
            ) : (
              <option value="">Tidak ada kelas diampu</option>
            )}
          </select>
        </div>
        <div className="w-full md:w-1/3">
          <input
            type="text"
            placeholder="Cari siswa (NIS/Nama)..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"
          />
        </div>
        <button
          onClick={handleAddStudent}
          className="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out"
        >
          + Tambah Siswa
        </button>
      </div>

      {error && <p className="text-red-600 text-center mb-4">{error}</p>}

      {loading ? (
        <p className="text-center text-gray-600">Memuat data siswa...</p>
      ) : filteredStudents.length === 0 ? (
        <p className="text-center text-gray-600">Tidak ada data siswa untuk kelas ini.</p>
      ) : (
        <div className="overflow-x-auto rounded-lg shadow-md border border-gray-200">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {filteredStudents.map(student => (
                <tr key={student.id}>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{student.nis}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{student.nama}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{student.kelas}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{student.statusSiswa}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button
                      onClick={() => handleEditStudent(student)}
                      className="text-indigo-600 hover:text-indigo-900 mr-3"
                    >
                      Edit
                    </button>
                    <button
                      onClick={() => confirmDeleteStudent(student)} // Memanggil konfirmasi modal
                      className="text-red-600 hover:text-red-900"
                    >
                      Hapus
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Modal Tambah/Edit Siswa */}
      {showModal && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg">
            <h3 className="text-2xl font-bold text-gray-900 mb-4">{isEditing ? 'Edit Siswa' : 'Tambah Siswa Baru'}</h3>
            <form onSubmit={handleSaveStudent} className="space-y-4">
              <div>
                <label htmlFor="nis" className="block text-sm font-medium text-gray-700">NIS</label>
                <input
                  type="text"
                  id="nis"
                  value={currentStudent.nis}
                  onChange={(e) => setCurrentStudent({ ...currentStudent, nis: e.target.value })}
                  required
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
              </div>
              <div>
                <label htmlFor="nama" className="block text-sm font-medium text-gray-700">Nama</label>
                <input
                  type="text"
                  id="nama"
                  value={currentStudent.nama}
                  onChange={(e) => setCurrentStudent({ ...currentStudent, nama: e.target.value })}
                  required
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
              </div>
              <div>
                <label htmlFor="kelas" className="block text-sm font-medium text-gray-700">Kelas</label>
                <select
                  id="kelas"
                  value={currentStudent.kelas}
                  onChange={(e) => setCurrentStudent({ ...currentStudent, kelas: e.target.value })}
                  required
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                >
                  {waliKelasClasses.map(cls => (
                    <option key={cls} value={cls}>{cls}</option>
                  ))}
                </select>
              </div>
              <div>
                <label htmlFor="tanggalLahir" className="block text-sm font-medium text-gray-700">Tanggal Lahir</label>
                <input
                  type="date" // Menggunakan type="date"
                  id="tanggalLahir"
                  value={currentStudent.tanggalLahir}
                  onChange={(e) => setCurrentStudent({ ...currentStudent, tanggalLahir: e.target.value })}
                  required
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
              </div>
              <div>
                <label htmlFor="alamat" className="block text-sm font-medium text-gray-700">Alamat</label>
                <textarea
                  id="alamat"
                  value={currentStudent.alamat}
                  onChange={(e) => setCurrentStudent({ ...currentStudent, alamat: e.target.value })}
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                ></textarea>
              </div>
              <div>
                <label htmlFor="nomorTeleponOrtu" className="block text-sm font-medium text-gray-700">Nomor Telepon Ortu</label>
                <input
                  type="text"
                  id="nomorTeleponOrtu"
                  value={currentStudent.nomorTeleponOrtu}
                  onChange={(e) => setCurrentStudent({ ...currentStudent, nomorTeleponOrtu: e.target.value })}
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
              </div>
              <div>
                <label htmlFor="statusSiswa" className="block text-sm font-medium text-gray-700">Status Siswa</label>
                <select
                  id="statusSiswa"
                  value={currentStudent.statusSiswa}
                  onChange={(e) => setCurrentStudent({ ...currentStudent, statusSiswa: e.target.value })}
                  required
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                >
                  <option value="Aktif">Aktif</option>
                  <option value="Tidak Aktif">Tidak Aktif</option>
                  <option value="Lulus">Lulus</option>
                  <option value="Pindah">Pindah</option>
                </select>
              </div>
              {error && <p className="text-red-600 text-sm text-center mt-4">{error}</p>}
              <div className="flex justify-end space-x-3 mt-6">
                <button
                  type="button"
                  onClick={() => setShowModal(false)}
                  className="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                  Batal
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 rounded-md bg-indigo-600 text-white font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                  Simpan
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Modal Konfirmasi Hapus */}
      {showDeleteConfirmModal && studentToDelete && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
            <h3 className="text-xl font-bold text-gray-900 mb-4">Konfirmasi Penghapusan</h3>
            <p className="text-gray-700 mb-6">
              Apakah Anda yakin ingin menghapus siswa <strong>{studentToDelete.nama}</strong> (NIS: {studentToDelete.nis})?
              Tindakan ini tidak dapat dibatalkan.
            </p>
            <div className="flex justify-end space-x-3">
              <button
                type="button"
                onClick={() => { setShowDeleteConfirmModal(false); setStudentToDelete(null); }}
                className="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
              >
                Batal
              </button>
              <button
                type="button"
                onClick={handleDeleteStudent}
                className="px-4 py-2 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
              >
                Hapus
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// --- Komponen Attendance ---
function Attendance({ waliKelasClasses }) {
  const { db, appId, user } = useContext(FirebaseContext);
  const [selectedClass, setSelectedClass] = useState('');
  const [students, setStudents] = useState([]);
  const [attendanceRecords, setAttendanceRecords] = useState({}); // { studentId: { status, notes } }
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [attendanceDate, setAttendanceDate] = useState(new Date().toISOString().split('T')[0]); // Default to today

  useEffect(() => {
    if (waliKelasClasses.length > 0) {
      setSelectedClass(waliKelasClasses[0]);
    } else {
      setSelectedClass('');
    }
  }, [waliKelasClasses]);

  useEffect(() => {
    if (!db || !selectedClass) {
      setStudents([]);
      setAttendanceRecords({});
      setLoading(false);
      return;
    }

    setLoading(true);
    setError('');

    // Fetch students for the selected class
    const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
    const qStudents = query(studentsRef, where("kelas", "==", selectedClass), where("statusSiswa", "==", "Aktif"));
    const unsubscribeStudents = onSnapshot(qStudents, (snapshot) => {
      const fetchedStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.nama.localeCompare(b.nama));
      setStudents(fetchedStudents);
      setLoading(false);
    }, (err) => {
      console.error("Error fetching students for attendance:", err);
      setError("Gagal memuat data siswa untuk kehadiran.");
      setLoading(false);
    });

    // Fetch attendance for the selected class and date
    const attendanceRef = collection(db, `artifacts/${appId}/public/data/attendance`);
    const qAttendance = query(attendanceRef, where("kelas", "==", selectedClass), where("tanggal", "==", attendanceDate));
    const unsubscribeAttendance = onSnapshot(qAttendance, (snapshot) => {
      const records = {};
      snapshot.forEach(doc => {
        const data = doc.data();
        records[data.siswaId] = { status: data.status, catatan: data.catatan || '' };
      });
      setAttendanceRecords(records);
    }, (err) => {
      console.error("Error fetching attendance records:", err);
      setError("Gagal memuat catatan kehadiran.");
    });

    return () => {
      unsubscribeStudents();
      unsubscribeAttendance();
    };
  }, [db, selectedClass, attendanceDate, appId]);

  const handleAttendanceChange = (studentId, status, catatan = '') => {
    setAttendanceRecords(prev => ({
      ...prev,
      [studentId]: { status, catatan }
    }));
  };

  const handleSaveAttendance = async () => {
    if (!db || !selectedClass || !user) {
      setError("Firebase atau data pengguna belum siap.");
      return;
    }
    setLoading(true);
    setError('');
    const batch = getFirestore().batch(); // Gunakan batch untuk operasi multi-dokumen

    try {
      for (const student of students) {
        const record = attendanceRecords[student.id];
        if (record && record.status) {
          const attendanceDocRef = doc(db, `artifacts/${appId}/public/data/attendance/${selectedClass}-${attendanceDate}-${student.id}`);
          batch.set(attendanceDocRef, {
            siswaId: student.id,
            nis: student.nis,
            namaSiswa: student.nama,
            kelas: selectedClass,
            tanggal: attendanceDate,
            status: record.status,
            catatan: record.catatan || '',
            recordedBy: user.uid,
            recordedByName: user.nama || user.uid,
            timestamp: new Date().toISOString()
          }, { merge: true }); // Gunakan merge untuk update jika sudah ada
        }
      }
      await batch.commit();
      console.log("Kehadiran berhasil disimpan!");
      alert("Kehadiran berhasil disimpan!"); // Ganti dengan notifikasi yang lebih baik
    } catch (err) {
      console.error("Error saving attendance:", err);
      setError("Gagal menyimpan kehadiran. Pastikan Anda memiliki izin akses Firestore.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="p-6 bg-white rounded-xl shadow-lg">
      <h2 className="text-3xl font-bold text-gray-900 mb-6">Manajemen Kehadiran Siswa</h2>

      <div className="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label htmlFor="select-class-attendance" className="block text-sm font-medium text-gray-700 mb-1">Pilih Kelas:</label>
          <select
            id="select-class-attendance"
            value={selectedClass}
            onChange={(e) => setSelectedClass(e.target.value)}
            className="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"
          >
            {waliKelasClasses.length > 0 ? (
              waliKelasClasses.map(cls => (
                <option key={cls} value={cls}>{cls}</option>
              ))
            ) : (
              <option value="">Tidak ada kelas diampu</option>
            )}
          </select>
        </div>
        <div>
          <label htmlFor="attendance-date" className="block text-sm font-medium text-gray-700 mb-1">Tanggal Kehadiran:</label>
          <input
            type="date"
            id="attendance-date"
            value={attendanceDate}
            onChange={(e) => setAttendanceDate(e.target.value)}
            className="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"
          />
        </div>
        {selectedClass && (
          <div className="flex items-end">
            <button
              onClick={handleSaveAttendance}
              className={`w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}
              disabled={loading}
            >
              {loading ? 'Menyimpan...' : 'Simpan Kehadiran'}
            </button>
          </div>
        )}
      </div>

      {error && <p className="text-red-600 text-center mb-4">{error}</p>}

      {!selectedClass ? (
        <p className="text-center text-gray-600">Pilih kelas untuk mengelola kehadiran.</p>
      ) : students.length === 0 ? (
        <p className="text-center text-gray-600">Tidak ada siswa aktif di kelas ini.</p>
      ) : (
        <div className="overflow-x-auto rounded-lg shadow-md border border-gray-200">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan (Opsional)</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {students.map(student => (
                <tr key={student.id}>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{student.nis}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{student.nama}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm">
                    <select
                      value={attendanceRecords[student.id]?.status || ''}
                      onChange={(e) => handleAttendanceChange(student.id, e.target.value, attendanceRecords[student.id]?.catatan || '')}
                      className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    >
                      <option value="">Pilih</option>
                      <option value="Hadir">Hadir</option>
                      <option value="Sakit">Sakit</option>
                      <option value="Izin">Izin</option>
                      <option value="Alpha">Alpha</option>
                    </select>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm">
                    <input
                      type="text"
                      value={attendanceRecords[student.id]?.catatan || ''}
                      onChange={(e) => handleAttendanceChange(student.id, attendanceRecords[student.id]?.status || '', e.target.value)}
                      placeholder="Catatan..."
                      className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    />
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}

// --- Komponen CaseBook ---
function CaseBook({ waliKelasClasses }) {
  const { db, appId, user } = useContext(FirebaseContext);
  const [selectedClass, setSelectedClass] = useState('');
  const [cases, setCases] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [currentCase, setCurrentCase] = useState({
    id: null, siswaId: '', nis: '', namaSiswa: '', kelas: '', tanggal: '', jenisKasus: '', deskripsi: '', penanganan: '', pelapor: ''
  });
  const [studentsInClass, setStudentsInClass] = useState([]); // Daftar siswa untuk dropdown
  const [searchTerm, setSearchTerm] = useState('');
  const [showDeleteConfirmModal, setShowDeleteConfirmModal] = useState(false);
  const [caseToDelete, setCaseToDelete] = useState(null);

  useEffect(() => {
    if (waliKelasClasses.length > 0) {
      setSelectedClass(waliKelasClasses[0]);
    } else {
      setSelectedClass('');
    }
  }, [waliKelasClasses]);

  useEffect(() => {
    if (!db || !selectedClass) {
      setCases([]);
      setStudentsInClass([]);
      setLoading(false);
      return;
    }

    setLoading(true);
    setError('');

    // Fetch students for the selected class (for dropdown in form)
    const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
    const qStudents = query(studentsRef, where("kelas", "==", selectedClass), where("statusSiswa", "==", "Aktif"));
    const unsubscribeStudents = onSnapshot(qStudents, (snapshot) => {
      const fetchedStudents = snapshot.docs.map(doc => ({ id: doc.id, nis: doc.data().nis, nama: doc.data().nama }));
      setStudentsInClass(fetchedStudents.sort((a,b) => a.nama.localeCompare(b.nama)));
    }, (err) => {
      console.error("Error fetching students for case book dropdown:", err);
      setError("Gagal memuat daftar siswa.");
    });

    // Fetch cases for the selected class
    const casesRef = collection(db, `artifacts/${appId}/public/data/cases`);
    const qCases = query(casesRef, where("kelas", "==", selectedClass));
    const unsubscribeCases = onSnapshot(qCases, (snapshot) => {
      const casesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));
      setCases(casesData);
      setLoading(false);
    }, (err) => {
      console.error("Error fetching cases:", err);
      setError("Gagal memuat data kasus.");
      setLoading(false);
    });

    return () => {
      unsubscribeStudents();
      unsubscribeCases();
    };
  }, [db, selectedClass, appId]);

  const filteredCases = cases.filter(kasus =>
    kasus.namaSiswa.toLowerCase().includes(searchTerm.toLowerCase()) ||
    kasus.jenisKasus.toLowerCase().includes(searchTerm.toLowerCase()) ||
    kasus.nis.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const handleAddCase = () => {
    setIsEditing(false);
    setCurrentCase({
      id: null, siswaId: '', nis: '', namaSiswa: '', kelas: selectedClass,
      tanggal: new Date().toISOString().split('T')[0], // Default ke tanggal hari ini
      jenisKasus: '', deskripsi: '', penanganan: '', pelapor: user?.nama || user?.uid || ''
    });
    setShowModal(true);
  };

  const handleEditCase = (kasus) => {
    setIsEditing(true);
    setCurrentCase({ ...kasus });
    setShowModal(true);
  };

  const confirmDeleteCase = (kasus) => {
    setCaseToDelete(kasus);
    setShowDeleteConfirmModal(true);
  };

  const handleDeleteCase = async () => {
    if (!caseToDelete || !db) return;

    try {
      await deleteDoc(doc(db, `artifacts/${appId}/public/data/cases`, caseToDelete.id));
      console.log("Kasus berhasil dihapus!");
      setShowDeleteConfirmModal(false);
      setCaseToDelete(null);
    } catch (err) {
      console.error("Error deleting case:", err);
      setError("Gagal menghapus kasus.");
    }
  };

  const handleSaveCase = async (e) => {
    e.preventDefault();
    setError('');
    // Dapatkan namaSiswa dan NIS berdasarkan siswaId yang dipilih
    const selectedStudent = studentsInClass.find(s => s.id === currentCase.siswaId);
    if (!selectedStudent) {
        setError("Siswa tidak valid.");
        return;
    }
    const caseDataToSave = {
        ...currentCase,
        nis: selectedStudent.nis,
        namaSiswa: selectedStudent.nama,
        kelas: selectedClass, // Pastikan kelas sesuai dengan yang dipilih
        lastUpdatedBy: user?.nama || user?.uid,
        lastUpdatedAt: new Date().toISOString()
    };
    // Hapus ID dari object sebelum update karena ID tidak perlu disimpan di dalam dokumen
    delete caseDataToSave.id;

    try {
      if (isEditing) {
        await updateDoc(doc(db, `artifacts/${appId}/public/data/cases`, currentCase.id), caseDataToSave);
        console.log("Kasus berhasil diperbarui!");
      } else {
        await addDoc(collection(db, `artifacts/${appId}/public/data/cases`), caseDataToSave);
        console.log("Kasus berhasil ditambahkan!");
      }
      setShowModal(false);
    } catch (err) {
      console.error("Error saving case:", err);
      setError("Gagal menyimpan data kasus. Pastikan Anda memiliki izin akses Firestore.");
    }
  };

  return (
    <div className="p-6 bg-white rounded-xl shadow-lg">
      <h2 className="text-3xl font-bold text-gray-900 mb-6">Buku Kasus Siswa</h2>

      <div className="mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4">
        <div className="w-full md:w-1/3">
          <label htmlFor="class-filter" className="sr-only">Pilih Kelas</label>
          <select
            id="class-filter"
            value={selectedClass}
            onChange={(e) => setSelectedClass(e.target.value)}
            className="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"
          >
            {waliKelasClasses.length > 0 ? (
              waliKelasClasses.map(cls => (
                <option key={cls} value={cls}>{cls}</option>
              ))
            ) : (
              <option value="">Tidak ada kelas diampu</option>
            )}
          </select>
        </div>
        <div className="w-full md:w-1/3">
          <input
            type="text"
            placeholder="Cari kasus (NIS/Nama/Jenis)..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"
          />
        </div>
        <button
          onClick={handleAddCase}
          className="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out"
        >
          + Tambah Kasus
        </button>
      </div>

      {error && <p className="text-red-600 text-center mb-4">{error}</p>}

      {loading ? (
        <p className="text-center text-gray-600">Memuat data kasus...</p>
      ) : filteredCases.length === 0 ? (
        <p className="text-center text-gray-600">Tidak ada data kasus untuk kelas ini.</p>
      ) : (
        <div className="overflow-x-auto rounded-lg shadow-md border border-gray-200">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Kasus</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {filteredCases.map(kasus => (
                <tr key={kasus.id}>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{kasus.tanggal}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{kasus.nis}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{kasus.namaSiswa}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{kasus.jenisKasus}</td>
                  <td className="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">{kasus.deskripsi}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button
                      onClick={() => handleEditCase(kasus)}
                      className="text-indigo-600 hover:text-indigo-900 mr-3"
                    >
                      Edit
                    </button>
                    <button
                      onClick={() => confirmDeleteCase(kasus)}
                      className="text-red-600 hover:text-red-900"
                    >
                      Hapus
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Modal Tambah/Edit Kasus */}
      {showModal && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg">
            <h3 className="text-2xl font-bold text-gray-900 mb-4">{isEditing ? 'Edit Kasus' : 'Tambah Kasus Baru'}</h3>
            <form onSubmit={handleSaveCase} className="space-y-4">
              <div>
                <label htmlFor="siswaId" className="block text-sm font-medium text-gray-700">Siswa</label>
                <select
                  id="siswaId"
                  value={currentCase.siswaId}
                  onChange={(e) => setCurrentCase({ ...currentCase, siswaId: e.target.value })}
                  required
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                >
                  <option value="">Pilih Siswa</option>
                  {studentsInClass.map(student => (
                    <option key={student.id} value={student.id}>{student.nama} ({student.nis})</option>
                  ))}
                </select>
              </div>
              <div>
                <label htmlFor="tanggal" className="block text-sm font-medium text-gray-700">Tanggal</label>
                <input
                  type="date"
                  id="tanggal"
                  value={currentCase.tanggal}
                  onChange={(e) => setCurrentCase({ ...currentCase, tanggal: e.target.value })}
                  required
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
              </div>
              <div>
                <label htmlFor="jenisKasus" className="block text-sm font-medium text-gray-700">Jenis Kasus</label>
                <input
                  type="text"
                  id="jenisKasus"
                  value={currentCase.jenisKasus}
                  onChange={(e) => setCurrentCase({ ...currentCase, jenisKasus: e.target.value })}
                  required
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
              </div>
              <div>
                <label htmlFor="deskripsi" className="block text-sm font-medium text-gray-700">Deskripsi</label>
                <textarea
                  id="deskripsi"
                  value={currentCase.deskripsi}
                  onChange={(e) => setCurrentCase({ ...currentCase, deskripsi: e.target.value })}
                  required
                  rows="3"
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                ></textarea>
              </div>
              <div>
                <label htmlFor="penanganan" className="block text-sm font-medium text-gray-700">Penanganan</label>
                <textarea
                  id="penanganan"
                  value={currentCase.penanganan}
                  onChange={(e) => setCurrentCase({ ...currentCase, penanganan: e.target.value })}
                  rows="3"
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                ></textarea>
              </div>
              <div>
                <label htmlFor="pelapor" className="block text-sm font-medium text-gray-700">Pelapor</label>
                <input
                  type="text"
                  id="pelapor"
                  value={currentCase.pelapor}
                  onChange={(e) => setCurrentCase({ ...currentCase, pelapor: e.target.value })}
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
              </div>
              {error && <p className="text-red-600 text-sm text-center mt-4">{error}</p>}
              <div className="flex justify-end space-x-3 mt-6">
                <button
                  type="button"
                  onClick={() => setShowModal(false)}
                  className="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                  Batal
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 rounded-md bg-indigo-600 text-white font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                  Simpan
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Modal Konfirmasi Hapus Kasus */}
      {showDeleteConfirmModal && caseToDelete && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
            <h3 className="text-xl font-bold text-gray-900 mb-4">Konfirmasi Penghapusan Kasus</h3>
            <p className="text-gray-700 mb-6">
              Apakah Anda yakin ingin menghapus kasus **{caseToDelete.jenisKasus}** untuk **{caseToDelete.namaSiswa}** pada tanggal {caseToDelete.tanggal}?
              Tindakan ini tidak dapat dibatalkan.
            </p>
            <div className="flex justify-end space-x-3">
              <button
                type="button"
                onClick={() => { setShowDeleteConfirmModal(false); setCaseToDelete(null); }}
                className="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
              >
                Batal
              </button>
              <button
                type="button"
                onClick={handleDeleteCase}
                className="px-4 py-2 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
              >
                Hapus
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}


// --- Komponen Mutation ---
function Mutation({ waliKelasClasses }) {
  const { db, appId, user } = useContext(FirebaseContext);
  const [selectedClass, setSelectedClass] = useState('');
  const [mutations, setMutations] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [currentMutation, setCurrentMutation] = useState({
    id: null, siswaId: '', nis: '', namaSiswa: '', kelas: '', tanggalMutasi: '', jenisMutasi: '', sekolahAsalTujuan: '', alasanMutasi: ''
  });
  const [studentsInClass, setStudentsInClass] = useState([]); // Daftar siswa untuk dropdown
  const [searchTerm, setSearchTerm] = useState('');
  const [showDeleteConfirmModal, setShowDeleteConfirmModal] = useState(false);
  const [mutationToDelete, setMutationToDelete] = useState(null);

  useEffect(() => {
    if (waliKelasClasses.length > 0) {
      setSelectedClass(waliKelasClasses[0]);
    } else {
      setSelectedClass('');
    }
  }, [waliKelasClasses]);

  useEffect(() => {
    if (!db || !selectedClass) {
      setMutations([]);
      setStudentsInClass([]);
      setLoading(false);
      return;
    }

    setLoading(true);
    setError('');

    // Fetch students for the selected class (for dropdown in form)
    const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
    const qStudents = query(studentsRef, where("kelas", "==", selectedClass), where("statusSiswa", "==", "Aktif"));
    const unsubscribeStudents = onSnapshot(qStudents, (snapshot) => {
      const fetchedStudents = snapshot.docs.map(doc => ({ id: doc.id, nis: doc.data().nis, nama: doc.data().nama }));
      setStudentsInClass(fetchedStudents.sort((a,b) => a.nama.localeCompare(b.nama)));
    }, (err) => {
      console.error("Error fetching students for mutation dropdown:", err);
      setError("Gagal memuat daftar siswa.");
    });

    // Fetch mutations for the selected class
    const mutationsRef = collection(db, `artifacts/${appId}/public/data/mutation`);
    const qMutations = query(mutationsRef, where("kelas", "==", selectedClass));
    const unsubscribeMutations = onSnapshot(qMutations, (snapshot) => {
      const mutationsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => new Date(b.tanggalMutasi) - new Date(a.tanggalMutasi));
      setMutations(mutationsData);
      setLoading(false);
    }, (err) => {
      console.error("Error fetching mutations:", err);
      setError("Gagal memuat data mutasi.");
      setLoading(false);
    });

    return () => {
      unsubscribeStudents();
      unsubscribeMutations();
    };
  }, [db, selectedClass, appId]);

  const filteredMutations = mutations.filter(mutation =>
    mutation.namaSiswa.toLowerCase().includes(searchTerm.toLowerCase()) ||
    mutation.jenisMutasi.toLowerCase().includes(searchTerm.toLowerCase()) ||
    mutation.nis.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const handleAddMutation = () => {
    setIsEditing(false);
    setCurrentMutation({
      id: null, siswaId: '', nis: '', namaSiswa: '', kelas: selectedClass,
      tanggalMutasi: new Date().toISOString().split('T')[0], // Default ke tanggal hari ini
      jenisMutasi: '', sekolahAsalTujuan: '', alasanMutasi: ''
    });
    setShowModal(true);
  };

  const handleEditMutation = (mutation) => {
    setIsEditing(true);
    setCurrentMutation({ ...mutation });
    setShowModal(true);
  };

  const confirmDeleteMutation = (mutation) => {
    setMutationToDelete(mutation);
    setShowDeleteConfirmModal(true);
  };

  const handleDeleteMutation = async () => {
    if (!mutationToDelete || !db) return;

    try {
      await deleteDoc(doc(db, `artifacts/${appId}/public/data/mutation`, mutationToDelete.id));
      console.log("Mutasi berhasil dihapus!");
      setShowDeleteConfirmModal(false);
      setMutationToDelete(null);
    } catch (err) {
      console.error("Error deleting mutation:", err);
      setError("Gagal menghapus mutasi.");
    }
  };

  const handleSaveMutation = async (e) => {
    e.preventDefault();
    setError('');
    const selectedStudent = studentsInClass.find(s => s.id === currentMutation.siswaId);
    if (!selectedStudent) {
        setError("Siswa tidak valid.");
        return;
    }
    const mutationDataToSave = {
        ...currentMutation,
        nis: selectedStudent.nis,
        namaSiswa: selectedStudent.nama,
        kelas: selectedClass,
        lastUpdatedBy: user?.nama || user?.uid,
        lastUpdatedAt: new Date().toISOString()
    };
    delete mutationDataToSave.id;

    try {
      if (isEditing) {
        await updateDoc(doc(db, `artifacts/${appId}/public/data/mutation`, currentMutation.id), mutationDataToSave);
        console.log("Mutasi berhasil diperbarui!");
      } else {
        await addDoc(collection(db, `artifacts/${appId}/public/data/mutation`), mutationDataToSave);
        console.log("Mutasi berhasil ditambahkan!");
      }
      setShowModal(false);

      // Opsional: Perbarui status siswa di koleksi siswa setelah mutasi
      if (mutationDataToSave.jenisMutasi === 'Keluar' || mutationDataToSave.jenisMutasi === 'Pindah') {
        const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, selectedStudent.id);
        await updateDoc(studentDocRef, { statusSiswa: 'Pindah/Keluar' });
        console.log(`Status siswa ${selectedStudent.nama} diperbarui menjadi Pindah/Keluar.`);
      } else if (mutationDataToSave.jenisMutasi === 'Masuk') {
        const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, selectedStudent.id);
        await updateDoc(studentDocRef, { statusSiswa: 'Aktif' });
        console.log(`Status siswa ${selectedStudent.nama} diperbarui menjadi Aktif.`);
      }

    } catch (err) {
      console.error("Error saving mutation:", err);
      setError("Gagal menyimpan data mutasi. Pastikan Anda memiliki izin akses Firestore.");
    }
  };

  return (
    <div className="p-6 bg-white rounded-xl shadow-lg">
      <h2 className="text-3xl font-bold text-gray-900 mb-6">Manajemen Mutasi Siswa</h2>

      <div className="mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4">
        <div className="w-full md:w-1/3">
          <label htmlFor="class-filter" className="sr-only">Pilih Kelas</label>
          <select
            id="class-filter"
            value={selectedClass}
            onChange={(e) => setSelectedClass(e.target.value)}
            className="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"
          >
            {waliKelasClasses.length > 0 ? (
              waliKelasClasses.map(cls => (
                <option key={cls} value={cls}>{cls}</option>
              ))
            ) : (
              <option value="">Tidak ada kelas diampu</option>
            )}
          </select>
        </div>
        <div className="w-full md:w-1/3">
          <input
            type="text"
            placeholder="Cari mutasi (NIS/Nama/Jenis)..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"
          />
        </div>
        <button
          onClick={handleAddMutation}
          className="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out"
        >
          + Tambah Mutasi
        </button>
      </div>

      {error && <p className="text-red-600 text-center mb-4">{error}</p>}

      {loading ? (
        <p className="text-center text-gray-600">Memuat data mutasi...</p>
      ) : filteredMutations.length === 0 ? (
        <p className="text-center text-gray-600">Tidak ada data mutasi untuk kelas ini.</p>
      ) : (
        <div className="overflow-x-auto rounded-lg shadow-md border border-gray-200">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Mutasi</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asal/Tujuan</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {filteredMutations.map(mutation => (
                <tr key={mutation.id}>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{mutation.tanggalMutasi}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{mutation.nis}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{mutation.namaSiswa}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{mutation.jenisMutasi}</td>
                  <td className="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">{mutation.sekolahAsalTujuan}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button
                      onClick={() => handleEditMutation(mutation)}
                      className="text-indigo-600 hover:text-indigo-900 mr-3"
                    >
                      Edit
                    </button>
                    <button
                      onClick={() => confirmDeleteMutation(mutation)}
                      className="text-red-600 hover:text-red-900"
                    >
                      Hapus
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Modal Tambah/Edit Mutasi */}
      {showModal && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg">
            <h3 className="text-2xl font-bold text-gray-900 mb-4">{isEditing ? 'Edit Mutasi' : 'Tambah Mutasi Baru'}</h3>
            <form onSubmit={handleSaveMutation} className="space-y-4">
              <div>
                <label htmlFor="siswaId" className="block text-sm font-medium text-gray-700">Siswa</label>
                <select
                  id="siswaId"
                  value={currentMutation.siswaId}
                  onChange={(e) => setCurrentMutation({ ...currentMutation, siswaId: e.target.value })}
                  required
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                >
                  <option value="">Pilih Siswa</option>
                  {studentsInClass.map(student => (
                    <option key={student.id} value={student.id}>{student.nama} ({student.nis})</option>
                  ))}
                </select>
              </div>
              <div>
                <label htmlFor="tanggalMutasi" className="block text-sm font-medium text-gray-700">Tanggal Mutasi</label>
                <input
                  type="date"
                  id="tanggalMutasi"
                  value={currentMutation.tanggalMutasi}
                  onChange={(e) => setCurrentMutation({ ...currentMutation, tanggalMutasi: e.target.value })}
                  required
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
              </div>
              <div>
                <label htmlFor="jenisMutasi" className="block text-sm font-medium text-gray-700">Jenis Mutasi</label>
                <select
                  id="jenisMutasi"
                  value={currentMutation.jenisMutasi}
                  onChange={(e) => setCurrentMutation({ ...currentMutation, jenisMutasi: e.target.value })}
                  required
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                >
                  <option value="">Pilih Jenis</option>
                  <option value="Masuk">Masuk</option>
                  <option value="Keluar">Keluar</option>
                  <option value="Pindah Kelas">Pindah Kelas</option>
                </select>
              </div>
              <div>
                <label htmlFor="sekolahAsalTujuan" className="block text-sm font-medium text-gray-700">Sekolah Asal/Tujuan</label>
                <input
                  type="text"
                  id="sekolahAsalTujuan"
                  value={currentMutation.sekolahAsalTujuan}
                  onChange={(e) => setCurrentMutation({ ...currentMutation, sekolahAsalTujuan: e.target.value })}
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                  placeholder="Nama sekolah"
                />
              </div>
              <div>
                <label htmlFor="alasanMutasi" className="block text-sm font-medium text-gray-700">Alasan Mutasi</label>
                <textarea
                  id="alasanMutasi"
                  value={currentMutation.alasanMutasi}
                  onChange={(e) => setCurrentMutation({ ...currentMutation, alasanMutasi: e.target.value })}
                  rows="3"
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                ></textarea>
              </div>
              {error && <p className="text-red-600 text-sm text-center mt-4">{error}</p>}
              <div className="flex justify-end space-x-3 mt-6">
                <button
                  type="button"
                  onClick={() => setShowModal(false)}
                  className="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                  Batal
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 rounded-md bg-indigo-600 text-white font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                  Simpan
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Modal Konfirmasi Hapus Mutasi */}
      {showDeleteConfirmModal && mutationToDelete && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
            <h3 className="text-xl font-bold text-gray-900 mb-4">Konfirmasi Penghapusan Mutasi</h3>
            <p className="text-gray-700 mb-6">
              Apakah Anda yakin ingin menghapus mutasi **{mutationToDelete.jenisMutasi}** untuk **{mutationToDelete.namaSiswa}** pada tanggal {mutationToDelete.tanggalMutasi}?
              Tindakan ini tidak dapat dibatalkan.
            </p>
            <div className="flex justify-end space-x-3">
              <button
                type="button"
                onClick={() => { setShowDeleteConfirmModal(false); setMutationToDelete(null); }}
                className="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
              >
                Batal
              </button>
              <button
                type="button"
                onClick={handleDeleteMutation}
                className="px-4 py-2 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
              >
                Hapus
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// --- Komponen Reports ---
function Reports({ waliKelasClasses, userRole }) {
  const { db, appId } = useContext(FirebaseContext);
  const [selectedClass, setSelectedClass] = useState('');
  const [reportType, setReportType] = useState('attendance');
  const [startDate, setStartDate] = useState('');
  const [endDate, setEndDate] = useState('');
  const [reportData, setReportData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [gradesData, setGradesData] = useState([]); // Untuk laporan KKTP
  const [selectedMonth, setSelectedMonth] = useState('');

  useEffect(() => {
    if (waliKelasClasses.length > 0) {
      setSelectedClass(waliKelasClasses[0]);
    } else {
      setSelectedClass('');
    }
  }, [waliKelasClasses]);

  useEffect(() => {
    // Set default dates for attendance report (last 30 days)
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);
    setEndDate(today.toISOString().split('T')[0]);
    setStartDate(thirtyDaysAgo.toISOString().split('T')[0]);

    // Set default month for grades report
    const currentMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
    setSelectedMonth(currentMonth);
  }, []);

  const generateReport = async () => {
    if (!db || !selectedClass) {
      setError("Pilih kelas dan pastikan Firebase siap.");
      setReportData([]);
      setGradesData([]);
      return;
    }
    setLoading(true);
    setError('');
    setReportData([]);
    setGradesData([]); // Clear previous grades data

    try {
      if (reportType === 'attendance') {
        if (!startDate || !endDate) {
          setError("Pilih tanggal mulai dan tanggal akhir untuk laporan kehadiran.");
          setLoading(false);
          return;
        }
        const attendanceRef = collection(db, `artifacts/${appId}/public/data/attendance`);
        // Query untuk rentang tanggal
        const q = query(attendanceRef,
          where("kelas", "==", selectedClass),
          where("tanggal", ">=", startDate),
          where("tanggal", "<=", endDate));
        const snapshot = await getDocs(q);
        const data = snapshot.docs.map(doc => doc.data());

        // Agregasi data kehadiran per siswa
        const summary = {};
        data.forEach(record => {
          if (!summary[record.siswaId]) {
            summary[record.siswaId] = {
              nis: record.nis,
              namaSiswa: record.namaSiswa,
              Hadir: 0, Sakit: 0, Izin: 0, Alpha: 0
            };
          }
          if (record.status) {
            summary[record.siswaId][record.status]++;
          }
        });
        setReportData(Object.values(summary).sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa)));

      } else if (reportType === 'cases') {
        const casesRef = collection(db, `artifacts/${appId}/public/data/cases`);
        const q = query(casesRef, where("kelas", "==", selectedClass));
        const snapshot = await getDocs(q);
        const data = snapshot.docs.map(doc => doc.data()).sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));
        setReportData(data);
      } else if (reportType === 'mutation') {
        const mutationRef = collection(db, `artifacts/${appId}/public/data/mutation`);
        const q = query(mutationRef, where("kelas", "==", selectedClass));
        const snapshot = await getDocs(q);
        const data = snapshot.docs.map(doc => doc.data()).sort((a,b) => new Date(b.tanggalMutasi) - new Date(a.tanggalMutasi));
        setReportData(data);
      } else if (reportType === 'kktp') { // Laporan KKTP (Nilai)
        if (!selectedMonth) {
          setError("Pilih bulan untuk laporan KKTP.");
          setLoading(false);
          return;
        }
        const gradesRef = collection(db, `artifacts/${appId}/public/data/grades`);
        const q = query(gradesRef,
            where("kelas", "==", selectedClass),
            where("bulan", "==", selectedMonth)
        );
        const snapshot = await getDocs(q);
        const data = snapshot.docs.map(doc => doc.data());

        // Agregasi data nilai per siswa dan mata pelajaran
        const gradesSummary = {};
        data.forEach(record => {
          const key = `${record.siswaId}-${record.mataPelajaran}`;
          if (!gradesSummary[key]) {
            gradesSummary[key] = {
              nis: record.nis,
              namaSiswa: record.namaSiswa,
              mataPelajaran: record.mataPelajaran,
              nilai: record.nilai,
              kktp: record.kktp,
              status: record.nilai >= record.kktp ? 'Tuntas' : 'Belum Tuntas'
            };
          }
        });
        setGradesData(Object.values(gradesSummary).sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa)));
      }

    } catch (err) {
      console.error("Error generating report:", err);
      setError("Gagal menghasilkan laporan. Pastikan Anda memiliki izin akses Firestore dan indeks yang diperlukan.");
    } finally {
      setLoading(false);
    }
  };

  const handlePrint = () => {
    window.print();
  };

  return (
    <div className="p-6 bg-white rounded-xl shadow-lg print:p-0 print:shadow-none">
      <h2 className="text-3xl font-bold text-gray-900 mb-6 print:text-xl print:text-center print:mb-4">Laporan Wali Kelas</h2>

      <div className="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4 print:hidden">
        <div>
          <label htmlFor="select-class-report" className="block text-sm font-medium text-gray-700 mb-1">Pilih Kelas:</label>
          <select
            id="select-class-report"
            value={selectedClass}
            onChange={(e) => setSelectedClass(e.target.value)}
            className="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"
          >
            {waliKelasClasses.length > 0 ? (
              waliKelasClasses.map(cls => (
                <option key={cls} value={cls}>{cls}</option>
              ))
            ) : (
              <option value="">Tidak ada kelas diampu</option>
            )}
          </select>
        </div>
        <div>
          <label htmlFor="report-type" className="block text-sm font-medium text-gray-700 mb-1">Jenis Laporan:</label>
          <select
            id="report-type"
            value={reportType}
            onChange={(e) => setReportType(e.target.value)}
            className="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"
          >
            <option value="attendance">Rekap Kehadiran</option>
            <option value="cases">Rekap Kasus</option>
            <option value="mutation">Rekap Mutasi</option>
            <option value="kktp">KKTP (Nilai)</option>
          </select>
        </div>

        {reportType === 'attendance' && (
          <>
            <div>
              <label htmlFor="start-date" className="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai:</label>
              <input
                type="date"
                id="start-date"
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
                className="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"
              />
            </div>
            <div>
              <label htmlFor="end-date" className="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir:</label>
              <input
                type="date"
                id="end-date"
                value={endDate}
                onChange={(e) => setEndDate(e.target.value)}
                className="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"
              />
            </div>
          </>
        )}

        {reportType === 'kktp' && (
          <div>
            <label htmlFor="select-month" className="block text-sm font-medium text-gray-700 mb-1">Pilih Bulan:</label>
            <input
              type="month"
              id="select-month"
              value={selectedMonth}
              onChange={(e) => setSelectedMonth(e.target.value)}
              className="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"
            />
          </div>
        )}

        <div className="md:col-span-4 flex justify-end space-x-3">
          <button
            onClick={generateReport}
            className={`bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out ${loading ? 'opacity-70 cursor-not-allowed' : ''}`}
            disabled={loading}
          >
            {loading ? 'Membuat Laporan...' : 'Buat Laporan'}
          </button>
          <button
            onClick={handlePrint}
            className="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out"
          >
            Cetak Laporan
          </button>
        </div>
      </div>

      {error && <p className="text-red-600 text-center mb-4 print:hidden">{error}</p>}

      {loading && <p className="text-center text-gray-600">Memuat laporan...</p>}

      {!selectedClass && !loading && (
        <p className="text-center text-gray-600">Pilih kelas dan jenis laporan untuk melihat data.</p>
      )}

      {selectedClass && !loading && reportData.length === 0 && gradesData.length === 0 && !error && (
        <p className="text-center text-gray-600">Tidak ada data untuk laporan ini pada kelas dan periode yang dipilih.</p>
      )}

      {/* Tampilan Laporan Kehadiran */}
      {reportType === 'attendance' && reportData.length > 0 && (
        <div className="mt-8">
          <h3 className="text-2xl font-bold text-gray-900 mb-4 print:text-lg">Rekap Kehadiran Kelas {selectedClass}</h3>
          <p className="text-gray-700 mb-4 print:text-sm">Periode: {startDate} s/d {endDate}</p>
          <div className="overflow-x-auto rounded-lg shadow-md border border-gray-200">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hadir</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sakit</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Izin</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alpha</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {reportData.map((data, index) => (
                  <tr key={index}>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.nis}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.namaSiswa}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.Hadir}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.Sakit}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.Izin}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.Alpha}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Tampilan Laporan Kasus */}
      {reportType === 'cases' && reportData.length > 0 && (
        <div className="mt-8">
          <h3 className="text-2xl font-bold text-gray-900 mb-4 print:text-lg">Rekap Kasus Kelas {selectedClass}</h3>
          <div className="overflow-x-auto rounded-lg shadow-md border border-gray-200">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Kasus</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Penanganan</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pelapor</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {reportData.map((data, index) => (
                  <tr key={index}>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.tanggal}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.nis}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.namaSiswa}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.jenisKasus}</td>
                    <td className="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">{data.deskripsi}</td>
                    <td className="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">{data.penanganan}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.pelapor}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Tampilan Laporan Mutasi */}
      {reportType === 'mutation' && reportData.length > 0 && (
        <div className="mt-8">
          <h3 className="text-2xl font-bold text-gray-900 mb-4 print:text-lg">Rekap Mutasi Siswa Kelas {selectedClass}</h3>
          <div className="overflow-x-auto rounded-lg shadow-md border border-gray-200">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Mutasi</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Mutasi</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sekolah Asal/Tujuan</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alasan Mutasi</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {reportData.map((data, index) => (
                  <tr key={index}>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.tanggalMutasi}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.nis}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.namaSiswa}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.jenisMutasi}</td>
                    <td className="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">{data.sekolahAsalTujuan}</td>
                    <td className="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">{data.alasanMutasi}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Tampilan Laporan KKTP (Nilai) */}
      {reportType === 'kktp' && gradesData.length > 0 && (
        <div className="mt-8">
          <h3 className="text-2xl font-bold text-gray-900 mb-4 print:text-lg">Laporan KKTP Kelas {selectedClass} - Bulan {selectedMonth}</h3>
          <div className="overflow-x-auto rounded-lg shadow-md border border-gray-200">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KKTP</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {gradesData.map((data, index) => (
                  <tr key={index}>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.nis}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.namaSiswa}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.mataPelajaran}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.nilai}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.kktp}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{data.status}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}
    </div>
  );
}


// --- Komponen UserManagement (hanya untuk Admin) ---
function UserManagement({ allClasses }) {
  const { db, appId, user } = useContext(FirebaseContext);
  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [currentUserData, setCurrentUserData] = useState({
    id: null, nik: '', nama: '', role: 'walikelas', kelasDiampu: []
  });
  const [searchTerm, setSearchTerm] = useState('');
  const [showDeleteConfirmModal, setShowDeleteConfirmModal] = useState(false);
  const [userToDelete, setUserToDelete] = useState(null);

  useEffect(() => {
    if (!db) return;

    setLoading(true);
    setError('');
    // Ambil data dari koleksi 'public/data/users' untuk ditampilkan
    const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
    const unsubscribe = onSnapshot(usersRef, (snapshot) => {
      const usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setUsers(usersData.sort((a,b) => a.nama.localeCompare(b.nama)));
      setLoading(false);
    }, (err) => {
      console.error("Error fetching users for management:", err);
      setError("Gagal memuat data pengguna. Pastikan Anda memiliki izin akses Firestore.");
      setLoading(false);
    });

    return () => unsubscribe();
  }, [db, appId]);

  const filteredUsers = users.filter(usr =>
    usr.nama.toLowerCase().includes(searchTerm.toLowerCase()) ||
    usr.nik.toLowerCase().includes(searchTerm.toLowerCase()) ||
    usr.role.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const handleAddUser = () => {
    setIsEditing(false);
    setCurrentUserData({
      id: null, nik: '', nama: '', role: 'walikelas', kelasDiampu: []
    });
    setShowModal(true);
  };

  const handleEditUser = (usr) => {
    setIsEditing(true);
    setCurrentUserData({ ...usr });
    setShowModal(true);
  };

  const confirmDeleteUser = (usr) => {
    setUserToDelete(usr);
    setShowDeleteConfirmModal(true);
  };

  const handleDeleteUser = async () => {
    if (!userToDelete || !db) return;

    try {
      // Hapus dari koleksi public/data/users
      await deleteDoc(doc(db, `artifacts/${appId}/public/data/users`, userToDelete.id));
      console.log("Pengguna berhasil dihapus dari public/data/users!");

      // Opsional: Hapus juga data profil di koleksi 'users/{uid}/profile/data' jika ada dan UID diketahui
      // Ini kompleks karena kita tidak langsung memiliki UID Firebase dari NIK di sini,
      // kecuali Anda menyimpan mapping NIK-UID. Untuk demo, kita fokus pada public/data/users.
      // Implementasi lebih lanjut diperlukan untuk menghapus akun Firebase Auth atau profil terkait.

      setShowDeleteConfirmModal(false);
      setUserToDelete(null);
    } catch (err) {
      console.error("Error deleting user:", err);
      setError("Gagal menghapus pengguna. Pastikan Anda memiliki izin akses Firestore.");
    }
  };


  const handleSaveUser = async (e) => {
    e.preventDefault();
    setError('');

    // Periksa apakah NIK sudah ada untuk pengguna lain (jika tidak sedang mengedit pengguna yang sama)
    const nikExists = users.some(u => u.nik === currentUserData.nik && u.id !== currentUserData.id);
    if (nikExists) {
        setError("NIK ini sudah digunakan oleh pengguna lain.");
        return;
    }

    try {
      if (isEditing) {
        // Hapus ID dari object sebelum update karena ID tidak perlu disimpan di dalam dokumen
        const { id, ...dataToUpdate } = currentUserData;
        await updateDoc(doc(db, `artifacts/${appId}/public/data/users`, id), dataToUpdate);
        console.log("Pengguna berhasil diperbarui!");
      } else {
        await addDoc(collection(db, `artifacts/${appId}/public/data/users`), currentUserData);
        console.log("Pengguna berhasil ditambahkan!");
      }
      setShowModal(false);
    } catch (err) {
      console.error("Error saving user:", err);
      setError("Gagal menyimpan data pengguna. Pastikan Anda memiliki izin akses Firestore.");
    }
  };

  return (
    <div className="p-6 bg-white rounded-xl shadow-lg">
      <h2 className="text-3xl font-bold text-gray-900 mb-6">Manajemen Pengguna</h2>

      <div className="mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4">
        <div className="w-full md:w-1/3">
          <input
            type="text"
            placeholder="Cari pengguna (NIK/Nama/Role)..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"
          />
        </div>
        <button
          onClick={handleAddUser}
          className="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out"
        >
          + Tambah Pengguna
        </button>
      </div>

      {error && <p className="text-red-600 text-center mb-4">{error}</p>}

      {loading ? (
        <p className="text-center text-gray-600">Memuat data pengguna...</p>
      ) : filteredUsers.length === 0 ? (
        <p className="text-center text-gray-600">Tidak ada data pengguna.</p>
      ) : (
        <div className="overflow-x-auto rounded-lg shadow-md border border-gray-200">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIK</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas Diampu</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {filteredUsers.map(usr => (
                <tr key={usr.id}>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{usr.nik}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{usr.nama}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{usr.role}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{(usr.kelasDiampu || []).join(', ')}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button
                      onClick={() => handleEditUser(usr)}
                      className="text-indigo-600 hover:text-indigo-900 mr-3"
                    >
                      Edit
                    </button>
                    {/* Admin tidak bisa menghapus dirinya sendiri */}
                    {!(usr.id === user.uid && usr.role === 'admin') && (
                      <button
                        onClick={() => confirmDeleteUser(usr)}
                        className="text-red-600 hover:text-red-900"
                      >
                        Hapus
                      </button>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Modal Tambah/Edit Pengguna */}
      {showModal && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg">
            <h3 className="text-2xl font-bold text-gray-900 mb-4">{isEditing ? 'Edit Pengguna' : 'Tambah Pengguna Baru'}</h3>
            <form onSubmit={handleSaveUser} className="space-y-4">
              <div>
                <label htmlFor="nik" className="block text-sm font-medium text-gray-700">NIK (Username)</label>
                <input
                  type="text"
                  id="nik"
                  value={currentUserData.nik}
                  onChange={(e) => setCurrentUserData({ ...currentUserData, nik: e.target.value })}
                  required
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
              </div>
              <div>
                <label htmlFor="nama" className="block text-sm font-medium text-gray-700">Nama</label>
                <input
                  type="text"
                  id="nama"
                  value={currentUserData.nama}
                  onChange={(e) => setCurrentUserData({ ...currentUserData, nama: e.target.value })}
                  required
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                />
              </div>
              <div>
                <label htmlFor="role" className="block text-sm font-medium text-gray-700">Role</label>
                <select
                  id="role"
                  value={currentUserData.role}
                  onChange={(e) => setCurrentUserData({ ...currentUserData, role: e.target.value, kelasDiampu: e.target.value === 'admin' ? [] : currentUserData.kelasDiampu })}
                  required
                  className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                >
                  <option value="walikelas">Wali Kelas</option>
                  <option value="admin">Admin Kurikulum</option>
                </select>
              </div>
              {currentUserData.role === 'walikelas' && (
                <div>
                  <label htmlFor="kelasDiampu" className="block text-sm font-medium text-gray-700">Kelas Diampu (pilih beberapa)</label>
                  <select
                    id="kelasDiampu"
                    multiple
                    value={currentUserData.kelasDiampu}
                    onChange={(e) => {
                      const options = Array.from(e.target.selectedOptions, option => option.value);
                      setCurrentUserData({ ...currentUserData, kelasDiampu: options });
                    }}
                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm h-32"
                  >
                    {allClasses.map(cls => (
                      <option key={cls} value={cls}>{cls}</option>
                    ))}
                  </select>
                  <p className="text-xs text-gray-500 mt-1">Tekan Ctrl/Cmd untuk memilih beberapa.</p>
                </div>
              )}
              {error && <p className="text-red-600 text-sm text-center mt-4">{error}</p>}
              <div className="flex justify-end space-x-3 mt-6">
                <button
                  type="button"
                  onClick={() => setShowModal(false)}
                  className="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                  Batal
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 rounded-md bg-indigo-600 text-white font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                  Simpan
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Modal Konfirmasi Hapus Pengguna */}
      {showDeleteConfirmModal && userToDelete && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl p-6 w-full max-w-sm">
            <h3 className="text-xl font-bold text-gray-900 mb-4">Konfirmasi Penghapusan Pengguna</h3>
            <p className="text-gray-700 mb-6">
              Apakah Anda yakin ingin menghapus pengguna **{userToDelete.nama}** ({userToDelete.nik})?
              Tindakan ini hanya menghapus entri dari koleksi `public/data/users` Anda dan tidak secara otomatis menghapus akun Firebase Auth terkait (jika ada).
            </p>
            <div className="flex justify-end space-x-3">
              <button
                type="button"
                onClick={() => { setShowDeleteConfirmModal(false); setUserToDelete(null); }}
                className="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
              >
                Batal
              </button>
              <button
                type="button"
                onClick={handleDeleteUser}
                className="px-4 py-2 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
              >
                Hapus
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}


// --- Fungsi Inisialisasi Data Demo ---
async function initializeDemoData(db, appId) {
  const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/users`);
  const classesCollectionRef = collection(db, `artifacts/${appId}/public/data/classes`);
  const studentsCollectionRef = collection(db, `artifacts/${appId}/public/data/students`);
  const attendanceCollectionRef = collection(db, `artifacts/${appId}/public/data/attendance`);
  const casesCollectionRef = collection(db, `artifacts/${appId}/public/data/cases`);
  const mutationCollectionRef = collection(db, `artifacts/${appId}/public/data/mutation`);
  const gradesCollectionRef = collection(db, `artifacts/${appId}/public/data/grades`);


  const currentMonth = `${new Date().getFullYear()}-${(new Date().getMonth() + 1).toString().padStart(2, '0')}`;
  const today = new Date().toISOString().split('T')[0];

  try {
    // Memeriksa apakah data sudah ada untuk menghindari duplikasi saat refresh
    const usersSnapshot = await getDocs(usersCollectionRef);
    if (!usersSnapshot.empty) {
      console.log("Data demo sudah ada, tidak perlu inisialisasi ulang.");
      return;
    }

    console.log("Menginisialisasi data demo...");

    // Add sample users
    await setDoc(doc(usersCollectionRef, "walikelas1"), {
      nik: "196801022005012006",
      nama: "Dra. Rusmini, M.M.Pd",
      role: "walikelas",
      kelasDiampu: ["X A", "XI B", "XII C"],
      password: "196801022005012006" // PENTING: Untuk demo. Di produksi, jangan simpan password di sini.
    });
    await setDoc(doc(usersCollectionRef, "walikelas2"), {
      nik: "197503152000021001",
      nama: "Bapak Budi",
      role: "walikelas",
      kelasDiampu: ["XI A"],
      password: "197503152000021001"
    });
    await setDoc(doc(usersCollectionRef, "walikelas3"), {
      nik: "198007202008032002",
      nama: "Ibu Indah",
      role: "walikelas",
      kelasDiampu: ["XII A"],
      password: "198007202008032002"
    });
    await setDoc(doc(usersCollectionRef, "admin1"), {
      nik: "admin",
      nama: "Admin Kurikulum",
      role: "admin",
      kelasDiampu: [],
      password: "admin"
    });

    // Add sample classes
    await setDoc(doc(classesCollectionRef, "X A"), { namaKelas: "X A" });
    await setDoc(doc(classesCollectionRef, "XI A"), { namaKelas: "XI A" });
    await setDoc(doc(classesCollectionRef, "XI B"), { namaKelas: "XI B" });
    await setDoc(doc(classesCollectionRef, "XII A"), { namaKelas: "XII A" });
    await setDoc(doc(classesCollectionRef, "XII C"), { namaKelas: "XII C" });

    // Add sample students for X A
    const student1Ref = doc(studentsCollectionRef);
    await setDoc(student1Ref, { nis: "2024001", nama: "Andi Pratama", kelas: "X A", tanggalLahir: "2008-05-10", alamat: "Jl. Merdeka No. 1", nomorTeleponOrtu: "081234567890", statusSiswa: "Aktif" });
    const student2Ref = doc(studentsCollectionRef);
    await setDoc(student2Ref, { nis: "2024002", nama: "Budi Santoso", kelas: "X A", tanggalLahir: "2008-07-22", alamat: "Jl. Pahlawan No. 5", nomorTeleponOrtu: "081298765432", statusSiswa: "Aktif" });
    const student3Ref = doc(studentsCollectionRef);
    await setDoc(student3Ref, { nis: "2024003", nama: "Citra Dewi", kelas: "X A", tanggalLahir: "2008-01-15", alamat: "Jl. Kebon Jeruk No. 10", nomorTeleponOrtu: "081311223344", statusSiswa: "Aktif" });

    // Add sample students for XI A
    const student4Ref = doc(studentsCollectionRef);
    await setDoc(student4Ref, { nis: "2023001", nama: "Doni Setiawan", kelas: "XI A", tanggalLahir: "2007-03-01", alamat: "Jl. Anggrek No. 12", nomorTeleponOrtu: "081255667788", statusSiswa: "Aktif" });
    const student5Ref = doc(studentsCollectionRef);
    await setDoc(student5Ref, { nis: "2023002", nama: "Eva Lestari", kelas: "XI A", tanggalLahir: "2007-09-20", alamat: "Jl. Mawar No. 7", nomorTeleponOrtu: "081399887766", statusSiswa: "Aktif" });

    // Add sample attendance for today (X A)
    await addDoc(attendanceCollectionRef, {
      siswaId: student1Ref.id, nis: "2024001", namaSiswa: "Andi Pratama", kelas: "X A", tanggal: today, status: "Hadir", catatan: "", recordedBy: "demo_init", recordedByName: "Init Script", timestamp: new Date().toISOString()
    });
    await addDoc(attendanceCollectionRef, {
      siswaId: student2Ref.id, nis: "2024002", namaSiswa: "Budi Santoso", kelas: "X A", tanggal: today, status: "Sakit", catatan: "Demam", recordedBy: "demo_init", recordedByName: "Init Script", timestamp: new Date().toISOString()
    });
    await addDoc(attendanceCollectionRef, {
      siswaId: student3Ref.id, nis: "2024003", namaSiswa: "Citra Dewi", kelas: "X A", tanggal: today, status: "Izin", catatan: "Acara keluarga", recordedBy: "demo_init", recordedByName: "Init Script", timestamp: new Date().toISOString()
    });

    // Add sample cases (X A)
    await addDoc(casesCollectionRef, {
      siswaId: student1Ref.id, nis: "2024001", namaSiswa: "Andi Pratama", kelas: "X A", tanggal: "2024-07-20", jenisKasus: "Terlambat", deskripsi: "Datang terlambat 15 menit tanpa pemberitahuan.", penanganan: "Diberi teguran lisan.", pelapor: "Guru Piket"
    });
    await addDoc(casesCollectionRef, {
      siswaId: student2Ref.id, nis: "2024002", namaSiswa: "Budi Santoso", kelas: "X A", tanggal: "2024-07-18", jenisKasus: "Tidak mengerjakan PR", deskripsi: "Tidak mengumpulkan tugas Matematika.", penanganan: "Diminta mengerjakan saat istirahat.", pelapor: "Guru Matematika"
    });

    // Add sample mutation
    await addDoc(mutationCollectionRef, {
      siswaId: student5Ref.id, nis: "2023002", namaSiswa: "Eva Lestari", kelas: "XI A", tanggalMutasi: "2024-06-01", jenisMutasi: "Keluar", sekolahAsalTujuan: "SMA N 1 Bandung", alasanMutasi: "Mengikuti orang tua pindah kota"
    });

    // Contoh data nilai (untuk laporan KKTP)
    // Asumsi siswaId sudah ada
    const andiId = (await getDocs(query(studentsCollectionRef, where("nis", "==", "2024001")))).docs[0]?.id;
    const budiId = (await getDocs(query(studentsCollectionRef, where("nis", "==", "2024002")))).docs[0]?.id;
    const citraId = (await getDocs(query(studentsCollectionRef, where("nis", "==", "2024003")))).docs[0]?.id;


    if (andiId) {
        await addDoc(gradesCollectionRef, {
            siswaId: andiId, namaSiswa: "Andi Pratama", kelas: "X A", bulan: currentMonth, mataPelajaran: "Matematika", nilai: 70, kktp: 75
        });
        await addDoc(gradesCollectionRef, {
            siswaId: andiId, namaSiswa: "Andi Pratama", kelas: "X A", bulan: currentMonth, mataPelajaran: "Bahasa Indonesia", nilai: 85, kktp: 75
        });
    }
    if (budiId) {
        await addDoc(gradesCollectionRef, {
            siswaId: budiId, namaSiswa: "Budi Santoso", kelas: "X A", bulan: currentMonth, mataPelajaran: "Bahasa Indonesia", nilai: 80, kktp: 75
        });
        await addDoc(gradesCollectionRef, {
            siswaId: budiId, namaSiswa: "Budi Santoso", kelas: "X A", bulan: currentMonth, mataPelajaran: "Matematika", nilai: 65, kktp: 75
        });
    }
    if (citraId) {
        await addDoc(gradesCollectionRef, {
            siswaId: citraId, namaSiswa: "Citra Dewi", kelas: "X A", bulan: currentMonth, mataPelajaran: "IPA", nilai: 65, kktp: 70
        });
    }


    console.log("Inisialisasi data demo selesai!");
  } catch (error) {
    console.error("Gagal menginisialisasi data demo:", error);
  }
}

// Catatan:
// Pastikan komponen-komponen yang Anda gunakan di MainLayout (seperti Dashboard,
// StudentManagement, Attendance, dll.) didefinisikan secara terpisah di file ini
// atau diimpor dari file lain. Saya telah menyertakan definisinya di atas.
